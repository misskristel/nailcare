<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - Nails Booking</title>

<style>
/* ====== SAME CSS AS YOUR ORIGINAL (UNCHANGED) ====== */
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --primary-bg:#fff;
  --secondary-bg:#f5f5f5;
  --accent-primary:#000;
  --text-primary:#000;
  --text-secondary:#666;
  --border-color:#e0e0e0;
  --card-bg:#fff;
  --shadow:0 4px 6px rgba(0,0,0,.1);
  --shadow-hover:0 20px 25px rgba(0,0,0,.15);
}
body {
  font-family:Inter,system-ui;
  background:var(--primary-bg);
  min-height:100vh;
}
nav {
  position:fixed;
  top:0; left:0; right:0;
  background:#fff;
  border-bottom:1px solid var(--border-color);
  padding:1rem 2rem;
  z-index:1000;
}
.nav-container {
  max-width:1200px;
  margin:auto;
  display:flex;
  justify-content:space-between;
}
.logo { font-weight:700; text-decoration:none; color:#000; }
main {
  padding-top:6rem;
  display:flex;
  justify-content:center;
}
.profile-container {
  max-width:600px;
  width:100%;
  background:#fff;
  padding:3rem;
  border-radius:16px;
  border:1px solid var(--border-color);
  box-shadow:var(--shadow);
}
.profile-header { text-align:center; }
.avatar-container { position:relative; display:inline-block; }
.avatar {
  width:120px; height:120px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #000;
}
.avatar-upload {
  position:absolute;
  bottom:0; right:0;
  background:#000;
  color:#fff;
  width:36px; height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.avatar-upload input { display:none; }
.form-group { margin-bottom:1rem; }
input {
  width:100%;
  padding:.8rem;
  border-radius:8px;
  border:1px solid var(--border-color);
}
button {
  width:100%;
  padding:1rem;
  background:#000;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.message {
  display:none;
  padding:1rem;
  border-radius:8px;
  margin-bottom:1rem;
}
.message.success { background:#dcfce7; color:#166534; }
.message.error { background:#fee2e2; color:#991b1b; }
</style>
</head>

<body>

<nav>
  <div class="nav-container">
    <a href="dashboard.html" class="logo">Nail Care Booking</a>
    <a href="dashboard.html">‚Üê Back</a>
  </div>
</nav>

<main>
  <div class="profile-container">

    <h2 style="text-align:center">My Profile</h2>
    <div id="message" class="message"></div>

    <div class="profile-header">
      <div class="avatar-container">
        <img id="avatarImage" class="avatar" src="" alt="Avatar">
        <label class="avatar-upload">
          üì∑
          <input type="file" id="avatarInput" accept="image/*">
        </label>
      </div>
      <h3 id="userName">Loading...</h3>
      <p id="userUsername">@username</p>
    </div>

    <form id="profileForm">
      <div class="form-group">
        <input type="text" id="firstname" placeholder="First name" required>
      </div>
      <div class="form-group">
        <input type="text" id="lastname" placeholder="Last name" required>
      </div>
      <div class="form-group">
        <input type="text" id="username" placeholder="Username" required>
      </div>
      <div class="form-group">
        <input type="email" id="email" disabled>
      </div>
      <button type="submit">Update Profile</button>
    </form>

    <hr style="margin:2rem 0">

    <form id="passwordForm">
      <input type="password" id="currentPassword" placeholder="Current Password" required>
      <input type="password" id="newPassword" placeholder="New Password" required>
      <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
      <button type="submit">Change Password</button>
    </form>

  </div>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
const DEFAULT_AVATAR = 'https://nailcare.ccs4thyear.com/uploads/profile.png';
let userData = null;
let authToken = localStorage.getItem('authToken');

$(document).ready(async function () {
  if (!authToken) return location.href = 'login.html';

  $('#avatarImage').attr('src', DEFAULT_AVATAR);

  try {
    const res = await axios.get('https://nailcare.ccs4thyear.com/api/profile', {
      headers: { Authorization: `Bearer ${authToken}` }
    });

    userData = res.data;
    localStorage.setItem('userData', JSON.stringify(userData));
    populateProfile(userData);

  } catch {
    location.href = 'login.html';
  }
});

function populateProfile(data) {
  $('#firstname').val(data.firstname || '');
  $('#lastname').val(data.lastname || '');
  $('#username').val(data.username || '');
  $('#email').val(data.email || '');

  $('#userName').text(`${data.firstname || ''} ${data.lastname || ''}`.trim());
  $('#userUsername').text(`@${data.username}`);

  let avatar = DEFAULT_AVATAR;
  if (data.avatar_path) {
    avatar = data.avatar_path.startsWith('http')
      ? data.avatar_path
      : `https://nailcare.ccs4thyear.com/${data.avatar_path}`;
  }
  $('#avatarImage').attr('src', avatar);
}

$('#avatarImage').on('error', function () {
  $(this).attr('src', DEFAULT_AVATAR);
});

$('#avatarInput').on('change', async function () {
  const file = this.files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append('avatar', file);

  const res = await axios.post(
    'https://nailcare.ccs4thyear.com/api/profile/avatar',
    fd,
    { headers: { Authorization: `Bearer ${authToken}` } }
  );

  const path = res.data.avatar_path;
  const url = path.startsWith('http')
    ? path
    : `https://nailcare.ccs4thyear.com/${path}`;

  $('#avatarImage').attr('src', url);
  userData.avatar_path = path;
  localStorage.setItem('userData', JSON.stringify(userData));
  showMessage('Profile picture updated!', 'success');
});

function showMessage(msg, type) {
  $('#message').removeClass().addClass(`message ${type}`).text(msg).show();
  if (type === 'success') setTimeout(() => $('#message').hide(), 3000);
}
</script>

</body>
</html>
